# BYWG项目服务端客户端分离架构设计

## 1. 当前架构分析

### 1.1 当前架构概述
当前项目是一个集成了OPC UA服务器功能和工业协议管理功能的WPF应用程序，主要特点是UI与业务逻辑紧密耦合。

### 1.2 当前架构的主要问题
- UI与业务逻辑紧密耦合，MainWindow直接实例化和操作核心业务组件
- OPC UA服务端功能和工业协议管理功能混在同一个进程中
- 缺少清晰的分层结构，不利于维护和扩展
- 无法独立部署和扩展服务端组件

### 1.3 当前核心组件
- **MainWindow.xaml.cs**: 包含UI逻辑，同时也包含业务逻辑（直接操作OPC UA服务器和工业协议管理器）
- **IndustrialProtocolManager.cs**: 管理各种工业协议的连接和数据采集
- **SimpleOpcUaServer.cs**: 实现OPC UA服务器功能，处理客户端连接和请求
- **BYWGLib.ProtocolManager**: 基础库中的协议管理功能

## 2. 服务端客户端分离架构设计

### 2.1 总体架构
![架构图] 
```
┌─────────────────┐      ┌─────────────────┐
│    客户端应用    │◄────►│    服务端应用    │
│  (WPF/WASM/Win) │      │   (Windows服务)  │
└─────────────────┘      └────────┬────────┘
                                 │
                         ┌───────┴───────┐
                         │  工业协议适配器  │
                         └───────┬───────┘
                                 │
                    ┌────────────┴────────────┐
                    │                         │
            ┌───────▼───────┐         ┌───────▼───────┐
            │  Modbus协议   │         │ Siemens协议   │
            └───────┬───────┘         └───────┬───────┘
                    │                         │
            ┌───────▼───────┐         ┌───────▼───────┐
            │  工业设备A    │         │  工业设备B    │
            └───────────────┘         └───────────────┘
```

### 2.2 服务端设计

#### 2.2.1 服务端组件
- **BYWG.Server**: Windows服务或控制台应用程序，作为独立的服务端进程运行
- **BYWG.Server.Core**: 核心业务逻辑库，包含协议管理和OPC UA服务器功能
- **BYWG.Contracts**: 定义服务端和客户端之间的通信接口和数据契约

#### 2.2.2 服务端主要功能
1. 工业协议管理
2. OPC UA服务器功能
3. 数据采集和处理
4. 配置管理
5. 日志记录

#### 2.2.3 通信机制
- 使用gRPC或WebSocket作为服务端和客户端之间的通信协议
- 定义清晰的服务接口和数据契约

### 2.3 客户端设计

#### 2.3.1 客户端组件
- **BYWG.Client**: WPF桌面应用程序，提供用户界面
- **BYWG.Client.Core**: 客户端核心逻辑库，包含与服务端通信的客户端代理
- **BYWG.Contracts**: 与服务端共享的通信接口和数据契约

#### 2.3.2 客户端主要功能
1. 用户界面展示
2. 配置管理界面
3. 数据监控和可视化
4. 服务端连接管理

## 3. 实施步骤

### 3.1 第一步：创建解决方案结构
1. 创建新的解决方案BYWG.Architected
2. 添加以下项目：
   - BYWG.Contracts
   - BYWG.Server.Core
   - BYWG.Server
   - BYWG.Client.Core
   - BYWG.Client

### 3.2 第二步：定义通信接口
1. 在BYWG.Contracts中定义服务接口和数据契约
2. 定义服务端提供的所有API方法
3. 定义所有需要在服务端和客户端之间传递的数据结构

### 3.3 第三步：重构服务端逻辑
1. 将当前项目中的业务逻辑迁移到BYWG.Server.Core
2. 实现OPC UA服务器作为独立组件
3. 实现工业协议管理作为独立组件
4. 实现与客户端通信的服务接口

### 3.4 第四步：重构客户端逻辑
1. 创建新的WPF客户端应用程序
2. 实现与服务端通信的客户端代理
3. 重构UI界面，移除直接的业务逻辑调用

### 3.5 第五步：测试和验证
1. 测试服务端的独立运行
2. 测试客户端与服务端的通信
3. 验证所有功能是否正常工作

## 4. 代码重构建议

### 4.1 服务端代码重构
1. 将SimpleOpcUaServer从WPF应用中分离，作为独立服务运行
2. 将IndustrialProtocolManager重构为可独立部署的服务组件
3. 添加配置文件支持，实现配置外部化

### 4.2 客户端代码重构
1. 移除MainWindow.xaml.cs中的业务逻辑代码
2. 添加客户端代理，通过服务接口与服务端通信
3. 重构UI组件，使其仅关注展示逻辑

## 5. 预期收益

### 5.1 技术收益
- 提高代码可维护性和可扩展性
- 实现功能模块的独立部署和扩展
- 降低组件间的耦合度
- 提高系统的稳定性和可靠性

### 5.2 业务收益
- 支持多客户端同时连接同一服务端
- 便于系统的分布式部署
- 提供更好的性能和可伸缩性
- 降低维护成本